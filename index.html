<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CashFlow | Linear Style Finance</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- LZ String (Compression - kept for file exports) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- PeerJS (WebRTC) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '475px',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#FFFFFF',
                        surface: '#F8F9FA',      
                        surfaceHighlight: '#F1F3F5',
                        border: '#E5E7EB',
                        primary: '#5E6AD2',
                        success: '#10B981',      
                        danger: '#EF4444',
                        textMain: '#111827',     
                        textMuted: '#6B7280',    
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FFFFFF;
            color: #111827;
            -webkit-font-smoothing: antialiased;
            height: 100dvh; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #E5E7EB;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #D1D5DB;
        }

        /* Input Styling */
        .linear-input {
            background: transparent;
            border: 1px solid transparent;
            border-bottom: 1px solid #E5E7EB;
            transition: all 0.2s ease;
            border-radius: 0; 
            -webkit-appearance: none; 
        }
        .linear-input:focus {
            outline: none;
            border-bottom-color: #5E6AD2;
            background: rgba(94, 106, 210, 0.03);
        }
        
        select.linear-input {
            color: #111827;
        }

        /* Card Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #E5E7EB; 
            border: 1px solid #E5E7EB;
            min-width: 800px; 
        }
        .calendar-cell {
            background: #FFFFFF;
            min-height: 80px; 
            transition: background 0.2s;
            cursor: pointer;
        }
        @media (min-width: 1024px) {
            .calendar-cell {
                min-height: 120px; 
            }
        }
        .calendar-cell:hover {
            background: #F9FAFB;
        }
        .calendar-cell.today {
            background: rgba(94, 106, 210, 0.04);
        }
        .negative-balance {
            color: #EF4444;
            background: #FEF2F2;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Chip Delete Button */
        .chip-delete {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .group:hover .chip-delete {
            opacity: 1;
        }
        @media (max-width: 1024px) {
            .chip-delete {
                opacity: 1; 
            }
        }

        /* Modal Button Styles */
        .action-btn {
            @apply flex flex-col items-center justify-center p-4 w-full border border-border rounded-lg hover:bg-surfaceHighlight transition-colors gap-2 text-center;
        }
        .action-btn i {
            @apply text-2xl text-primary;
        }
        .action-btn strong {
            @apply text-textMain text-sm font-semibold;
        }
        .action-btn span {
            @apply text-textMuted text-[10px];
        }

        /* Choice Modal Button Styles (for series) */
        .choice-btn {
            @apply flex flex-col items-start p-3 w-full border border-border rounded-lg hover:bg-surfaceHighlight transition-colors text-left;
        }
        .choice-btn strong {
            @apply text-textMain text-xs font-semibold block mb-0.5;
        }
        .choice-btn span {
            @apply text-textMuted text-[10px];
        }

        /* Loading Overlay */
        #loadingOverlay {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
        
        /* Saving Indicator */
        #saveIndicator {
            transition: opacity 0.3s;
        }

        /* Collapsible Utilities */
        .collapsed-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease-out;
        }
        .expanded-content {
            max-height: 500px;
            opacity: 1;
            transition: all 0.3s ease-in;
        }
        .expanded-list-content {
            max-height: 60vh;
            opacity: 1;
            transition: all 0.3s ease-in;
        }
        .chevron-rotated {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body class="flex flex-col overflow-hidden text-sm font-sans">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[60] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mb-2"></div>
        <div class="text-textMuted text-xs font-medium animate-pulse">Syncing...</div>
    </div>

    <!-- Top Navigation -->
    <nav class="h-14 border-b border-border flex items-center justify-between px-4 lg:px-6 bg-white/80 backdrop-blur-md z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center text-white font-bold shadow-sm">
                <i class="ph ph-wave-sine"></i>
            </div>
            <span class="font-semibold tracking-tight text-textMain hidden xs:inline">CashFlow</span>
            <span id="saveIndicator" class="text-[10px] text-textMuted font-mono opacity-0 bg-surfaceHighlight px-2 py-0.5 rounded ml-2">Saving...</span>
        </div>
        <div class="flex items-center gap-2 lg:gap-4">
             <input type="file" id="importFile" class="hidden" accept=".json">
            <button onclick="openMethodModal('import')" class="text-textMuted hover:text-textMain transition-colors flex items-center gap-2 font-medium px-2 py-1 rounded hover:bg-surfaceHighlight">
                <i class="ph ph-download-simple text-lg"></i> 
                <span class="hidden sm:inline">Import</span>
            </button>
            <button onclick="openMethodModal('export')" class="text-textMuted hover:text-textMain transition-colors flex items-center gap-2 font-medium px-2 py-1 rounded hover:bg-surfaceHighlight">
                <i class="ph ph-upload-simple text-lg"></i> 
                <span class="hidden sm:inline">Export</span>
            </button>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-full lg:w-96 border-b lg:border-b-0 lg:border-r border-border bg-surface flex flex-col shrink-0 z-10 max-h-[45vh] lg:max-h-full overflow-hidden">
            
            <div class="flex-1 overflow-y-auto" id="sidebarScroll">
                <div class="p-4 lg:p-6 border-b border-border bg-white">
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-textMuted mb-1 text-[10px] uppercase tracking-wider font-bold">Current Bal</label>
                            <div class="relative">
                                <span class="absolute left-0 top-1.5 text-textMuted">$</span>
                                <input type="number" id="currentBalance" step="0.01" 
                                    class="linear-input w-full pl-3 py-1 text-lg font-mono text-textMain placeholder-textMuted/50 font-medium bg-transparent" 
                                    placeholder="0.00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-textMuted mb-1 text-[10px] uppercase tracking-wider font-bold text-danger">Min Limit</label>
                            <div class="relative">
                                <span class="absolute left-0 top-1.5 text-textMuted">$</span>
                                <input type="number" id="minBalance" step="0.01" 
                                    class="linear-input w-full pl-3 py-1 text-lg font-mono text-textMain placeholder-textMuted/50 font-medium bg-transparent border-danger/20 focus:border-danger" 
                                    placeholder="0.00">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mb-4 text-xs border-t border-border/50 pt-3">
                        <div class="flex-1">
                            <span class="text-textMuted block mb-0.5">In</span>
                            <span class="text-success font-mono font-medium" id="statsIncoming">$0.00</span>
                        </div>
                        <div class="flex-1">
                            <span class="text-textMuted block mb-0.5">Out</span>
                            <span class="text-danger font-mono font-medium" id="statsOutgoing">$0.00</span>
                        </div>
                    </div>

                    <!-- Collapsible Trigger -->
                    <button id="toggleFormBtn" class="w-full flex items-center justify-between text-textMuted uppercase text-[10px] font-bold tracking-widest mb-2 mt-4 hover:text-textMain transition-colors group">
                        <span id="formTitle">Add Entry</span>
                        <i id="formChevron" class="ph ph-caret-down text-lg transition-transform text-textMuted group-hover:text-textMain"></i>
                    </button>
                    
                    <!-- Collapsible Content -->
                    <div id="transactionFormContainer" class="expanded-content">
                        <form id="transactionForm" class="space-y-3 pt-1 pb-2">
                            <div class="flex gap-3">
                                <input type="text" id="transName" required placeholder="Description" 
                                    class="linear-input flex-1 py-1.5 text-textMain placeholder-textMuted/60 text-xs">
                            </div>
                            
                            <div class="flex gap-3">
                                <div class="flex-1 relative">
                                    <span class="absolute left-0 top-1.5 text-textMuted text-xs">$</span>
                                    <input type="number" id="transAmount" required step="0.01" placeholder="0.00" 
                                        class="linear-input w-full pl-3 py-1.5 text-textMain font-mono placeholder-textMuted/60 text-xs">
                                </div>
                                <select id="transType" class="linear-input flex-1 py-1.5 text-textMain bg-transparent cursor-pointer text-xs">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>

                            <div class="flex gap-3">
                                <input type="date" id="transDate" required 
                                    class="linear-input flex-1 py-1.5 text-textMain bg-transparent text-xs">
                                
                                <select id="transRecur" class="linear-input flex-1 py-1.5 text-textMain bg-transparent cursor-pointer text-xs" title="Frequency">
                                    <option value="none">One-time</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>

                            <div class="flex gap-2">
                                <button type="button" id="btnCancelEdit" onclick="cancelEdit()"
                                    class="hidden w-24 py-2 rounded-lg border border-border text-textMuted hover:bg-surfaceHighlight transition-all font-medium items-center justify-center text-xs">
                                    Cancel
                                </button>
                                <button type="submit" id="btnSubmit"
                                    class="flex-1 py-2 rounded-lg bg-white border border-border text-textMain hover:bg-surfaceHighlight transition-all font-medium flex items-center justify-center gap-2 group shadow-sm text-xs">
                                    <i class="ph ph-plus text-primary text-sm" id="btnSubmitIcon"></i>
                                    <span id="btnSubmitText">Add</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Upcoming List -->
                <div class="p-4 lg:p-6 bg-surface">
                    <button id="toggleLedgerBtn" class="w-full flex items-center justify-between text-textMuted uppercase text-[10px] font-bold tracking-widest mb-2 hover:text-textMain transition-colors group">
                        <span>Upcoming</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] bg-white border border-border px-2 py-0.5 rounded-full text-textMain font-medium" id="entryCount">0</span>
                            <!-- Default state: Rotated (Collapsed) -->
                            <i id="ledgerChevron" class="ph ph-caret-down text-lg transition-transform text-textMuted group-hover:text-textMain chevron-rotated"></i>
                        </div>
                    </button>
                    
                    <!-- Ledger List Container: Collapsed by default -->
                    <div id="ledgerList" class="space-y-2 pb-4 collapsed-content overflow-y-auto custom-scrollbar">
                        <!-- Ledger Items Render Here -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Calendar Area -->
        <main class="flex-1 flex flex-col bg-background overflow-hidden relative min-h-0">
            <!-- Calendar Controls -->
            <header class="h-14 border-b border-border flex items-center justify-between px-4 lg:px-6 shrink-0 bg-white">
                <div class="flex items-center gap-2">
                    <button id="prevMonth" class="p-1.5 rounded-md hover:bg-surfaceHighlight text-textMuted hover:text-textMain transition-colors">
                        <i class="ph ph-caret-left text-lg"></i>
                    </button>
                    <h2 class="text-base lg:text-lg font-semibold tracking-tight w-32 lg:w-48 text-center text-textMain truncate" id="monthDisplay">Month Year</h2>
                    <button id="nextMonth" class="p-1.5 rounded-md hover:bg-surfaceHighlight text-textMuted hover:text-textMain transition-colors">
                        <i class="ph ph-caret-right text-lg"></i>
                    </button>
                </div>
                
                <div class="hidden sm:flex items-center gap-4 text-[10px] lg:text-xs text-textMuted font-medium">
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-success"></div>
                        <span>In</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-danger"></div>
                        <span>Out</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 rounded-full bg-danger/10 border border-danger"></div>
                        <span>Below Limit</span>
                    </div>
                </div>
            </header>

            <!-- Calendar Grid -->
            <div class="flex-1 overflow-auto p-4 custom-scrollbar bg-surfaceHighlight/30 relative" id="calendarContainer">
                <div class="min-w-[800px]"> 
                    <div class="grid grid-cols-7 border-b border-border/0 bg-transparent text-[10px] text-textMuted font-semibold uppercase tracking-widest text-center py-2 mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar" class="calendar-grid rounded-xl overflow-hidden border border-border shadow-sm bg-white">
                        <!-- Cells -->
                    </div>
                </div>
            </div>
            
            <!-- Floating Summary -->
            <div class="absolute bottom-4 right-4 lg:bottom-8 lg:right-8 pointer-events-none z-30">
                <div class="glass-panel px-4 py-3 lg:px-5 lg:py-4 rounded-xl shadow-xl pointer-events-auto flex items-center gap-4 animate-fade border-white/20">
                    <div>
                        <div class="text-[10px] text-textMuted uppercase tracking-widest font-bold">End of Month</div>
                        <div class="text-xl lg:text-2xl font-mono font-semibold text-textMain" id="eomBalance">$0.00</div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Choice Modal (Recurring) -->
    <div id="choiceModal" class="fixed inset-0 bg-black/20 backdrop-blur-[2px] z-50 hidden flex items-center justify-center transition-all duration-200 opacity-0 p-4">
        <div class="bg-white border border-border p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-200" id="choiceModalContent">
            <div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center mb-4" id="choiceIconWrapper">
                <i class="ph ph-warning text-xl" id="choiceIcon"></i>
            </div>
            <h3 class="font-semibold text-textMain mb-2" id="choiceTitle">Recurring Transaction</h3>
            <p class="text-textMuted text-xs mb-6 leading-relaxed" id="choiceDesc">How do you want to apply this change?</p>
            <div class="flex flex-col gap-2">
                <button id="btnChoiceThis" class="choice-btn group">
                    <strong class="group-hover:text-primary">Only This Event</strong>
                    <span>Changes only this specific transaction.</span>
                </button>
                <button id="btnChoiceFuture" class="choice-btn group">
                    <strong class="group-hover:text-primary">This and Following Events</strong>
                    <span>Applies to this and all future transactions in the series.</span>
                </button>
                <button id="btnChoiceAll" class="choice-btn group">
                    <strong class="group-hover:text-primary">All Events</strong>
                    <span>Applies to past, present, and future transactions.</span>
                </button>
                <button id="btnChoiceCancel" class="mt-2 text-center text-textMuted hover:text-textMain text-xs font-medium py-2">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import/Export Method Modal -->
    <div id="methodModal" class="fixed inset-0 bg-black/20 backdrop-blur-[2px] z-50 hidden flex items-center justify-center transition-all duration-200 opacity-0 p-4">
        <div class="bg-white border border-border p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-200" id="methodModalContent">
            <h3 class="font-semibold text-textMain mb-4 text-center" id="methodTitle">Export Data</h3>
            <div class="flex gap-3 mb-4">
                <button id="btnMethodFile" class="action-btn group flex-1">
                    <i class="ph ph-file-text group-hover:text-indigo-500"></i>
                    <div>
                        <strong class="group-hover:text-primary block">JSON File</strong>
                        <span>Traditional file</span>
                    </div>
                </button>
                <button id="btnMethodQR" class="action-btn group flex-1">
                    <i class="ph ph-broadcast group-hover:text-indigo-500"></i>
                    <div>
                        <strong class="group-hover:text-primary block">Sync Devices</strong>
                        <span>WebRTC / QR</span>
                    </div>
                </button>
            </div>
            <button onclick="closeMethodModal()" class="w-full text-center text-textMuted hover:text-textMain text-xs font-medium py-2">Cancel</button>
        </div>
    </div>

    <!-- WebRTC Sync Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center transition-all duration-200 opacity-0 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md relative flex flex-col items-center" id="qrModalContent">
            <button onclick="closeQRModal()" class="absolute top-4 right-4 text-textMuted hover:text-textMain"><i class="ph ph-x text-xl"></i></button>
            
            <h3 class="font-semibold text-textMain mb-2" id="qrTitle">Device Sync</h3>
            
            <!-- Host Mode (Sender) -->
            <div id="qrGenContainer" class="hidden flex-col items-center w-full">
                <div class="text-xs text-textMuted mb-4 text-center">Scan with other device to connect</div>
                <div id="qrcode" class="bg-white p-2 rounded border border-border"></div>
                
                <div class="w-full mt-6 text-center">
                    <div class="text-[10px] uppercase text-textMuted font-bold tracking-widest mb-2">Or use this phrase</div>
                    <div id="hostPhraseDisplay" class="font-mono text-xl text-primary font-bold tracking-tight select-all"></div>
                </div>
                
                <div class="mt-4 flex items-center gap-2 text-xs text-textMuted">
                    <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse" id="hostStatusDot"></div>
                    <span id="hostStatusText">Waiting for connection...</span>
                </div>
            </div>

            <!-- Client Mode (Receiver) -->
            <div id="qrScanContainer" class="hidden w-full flex-col items-center">
                
                <!-- Tab Switcher for Scan vs Type -->
                <div class="flex w-full border-b border-border mb-4">
                    <button onclick="switchScanMode('camera')" id="tabCamera" class="flex-1 pb-2 text-xs font-medium text-primary border-b-2 border-primary transition-all">Scan QR</button>
                    <button onclick="switchScanMode('manual')" id="tabManual" class="flex-1 pb-2 text-xs font-medium text-textMuted hover:text-textMain transition-all">Enter Phrase</button>
                </div>

                <!-- Camera View -->
                <div id="cameraView" class="w-full">
                    <div id="reader" class="w-full rounded overflow-hidden bg-black h-64"></div>
                    <p class="text-xs text-textMuted mt-2 text-center">Point camera at the Sync QR code</p>
                </div>

                <!-- Manual Entry View -->
                <div id="manualView" class="w-full hidden">
                    <label class="text-xs text-textMuted mb-1 block">Enter 3-word phrase</label>
                    <div class="flex gap-2">
                        <input type="text" id="manualPhraseInput" placeholder="word-word-word" class="linear-input flex-1 py-2 text-textMain font-mono text-center lowercase">
                        <button onclick="connectToPhrase()" class="bg-primary text-white rounded px-4 text-xs font-medium hover:bg-indigo-600 transition-colors">Connect</button>
                    </div>
                    <p class="text-[10px] text-textMuted mt-4 text-center">Enter the phrase shown on the host device.</p>
                </div>

                <div id="clientStatus" class="mt-4 text-xs text-center hidden">
                    <i class="ph ph-spinner animate-spin"></i> Connecting...
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 translate-y-20 bg-textMain text-white px-5 py-2.5 rounded-lg font-medium shadow-xl transition-all duration-300 opacity-0 z-[70] flex items-center gap-2 max-w-[90vw] whitespace-nowrap">
        <i class="ph ph-check-circle text-success" id="toastIcon"></i>
        <span id="toastMsg">Action Successful</span>
    </div>

    <script>
        // --- State Management ---
        const STORE_KEY = 'cashflow_app_v2_storage';
        const SILO_READ_URL = 'https://api.jsonsilo.com/public/c49331a4-3618-48d4-9136-a82f1eef783b';
        const SILO_WRITE_URL = 'https://api.jsonsilo.com/api/v1/manage/c49331a4-3618-48d4-9136-a82f1eef783b';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX3V1aWQiOiI4REd5NENCcHR1ZTlhbHhVWTJoYWJPengzV0IyIiwiaXNzIjoiaHR0cHM6Ly9qc29uc2lsby5jb20iLCJleHAiOjE3Njc2NTcyNjF9.m_45zupzeQLtSK0aj0oRbjS3bg3qA7SjRnzKC6oKDlc';

        // Friendly words for IDs (256 words)
        const WORD_LIST = [
            "apple", "arch", "army", "atom", "baby", "ball", "band", "bank", "bath", "bear", "beef", "beer", "bell", "belt", "bird", "bite", "bike", "bill", "bind", "blue",
            "boat", "body", "bone", "book", "boom", "boot", "born", "boss", "bowl", "bulk", "burn", "bush", "busy", "cake", "calf", "call", "calm", "camp", "card", "care",
            "case", "cash", "cast", "cell", "chat", "chef", "city", "clam", "clay", "clip", "club", "code", "coil", "coin", "cold", "cone", "cook", "cool", "copy", "cord",
            "core", "cork", "corn", "cost", "crew", "crop", "crow", "cube", "cure", "curl", "cute", "dark", "data", "date", "dawn", "days", "deal", "dean", "dear", "debt",
            "deck", "deed", "deep", "deer", "demo", "desk", "dial", "dice", "diet", "disc", "dish", "disk", "dock", "doll", "door", "dose", "dove", "down", "draw", "drop",
            "drum", "duck", "dust", "duty", "each", "earn", "ease", "east", "easy", "edge", "edit", "else", "envy", "epic", "even", "ever", "evil", "exam", "exit", "face",
            "fact", "fade", "fail", "fair", "fall", "fame", "farm", "fast", "fate", "fear", "feed", "feel", "feet", "fell", "felt", "file", "fill", "film", "find", "fine",
            "fire", "firm", "fish", "fist", "five", "flag", "flat", "flew", "flip", "flow", "foam", "foil", "fold", "folk", "fond", "food", "foot", "ford", "fork", "form",
            "fort", "four", "free", "frog", "from", "fuel", "full", "fund", "fury", "fuse", "gain", "game", "gate", "gave", "gear", "gene", "gift", "girl", "give", "glad",
            "glow", "glue", "goal", "goat", "gold", "golf", "gone", "good", "grab", "gray", "grid", "grip", "grow", "gulf", "hack", "hair", "half", "hall", "halo", "hand",
            "hang", "hard", "hare", "harm", "harp", "hate", "hawk", "head", "heal", "heap", "hear", "heat", "heel", "heir", "held", "help", "herb", "herd", "here", "hero",
            "high", "hike", "hill", "hint", "hire", "hold", "hole", "home", "hood", "hook", "hope", "horn", "hose", "host", "hour", "huge", "hula", "hull", "hunt", "hurt",
            "icon", "idea", "idle", "inch", "info", "into", "iron", "item", "jack", "jade"
        ];

        let state = {
            currentBalance: 0,
            minBalance: 0,
            transactions: [], 
            viewDate: new Date()
        };

        let modalContext = { mode: null, targetId: null, payload: null };
        let editingId = null;
        let html5QrcodeScanner = null;
        let peer = null;
        let activeConnection = null;

        // --- Init ---
        async function init() {
            const overlay = document.getElementById('loadingOverlay');
            try { await loadData(); } 
            catch (error) { console.warn("Initial load failed", error); }
            
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); }, 300);

            document.getElementById('transDate').valueAsDate = new Date();
            render();
            setupModalListeners();
            setupCollapsible();
            setupLedgerCollapsible();
        }

        async function loadData() {
            let loaded = false;
            try {
                const response = await fetch(SILO_READ_URL, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const rawData = await response.json();
                    const data = rawData.data || rawData; 
                    const actualState = data.file_data || data;
                    if (actualState && (actualState.transactions || actualState.currentBalance !== undefined)) {
                        applyState(actualState);
                        loaded = true;
                        showToast("Synced from Cloud");
                    }
                }
            } catch (err) { console.warn('Silo Load Failed:', err); }

            if (!loaded) {
                const stored = localStorage.getItem(STORE_KEY);
                if (stored) {
                    applyState(JSON.parse(stored));
                    showToast("Loaded Local Data", true); 
                }
            }
        }

        function applyState(data) {
            state.currentBalance = parseFloat(data.currentBalance) || 0;
            state.minBalance = parseFloat(data.minBalance) || 0;
            state.transactions = Array.isArray(data.transactions) ? data.transactions : [];
            state.transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            document.getElementById('currentBalance').value = state.currentBalance;
            document.getElementById('minBalance').value = state.minBalance;
        }

        async function saveData() {
            localStorage.setItem(STORE_KEY, JSON.stringify(state));
            render(); 
            const indicator = document.getElementById('saveIndicator');
            indicator.innerText = "Syncing...";
            indicator.classList.remove('opacity-0');

            try {
                const response = await fetch(SILO_WRITE_URL, {
                    method: 'PATCH', 
                    headers: { 'Content-Type': 'application/json', 'X-MAN-API': API_KEY },
                    body: JSON.stringify({
                        file_name: 'CashFlow Data',
                        file_data: state,
                        region_name: 'api',
                        is_public: true
                    })
                });
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                indicator.innerText = "Synced";
                setTimeout(() => indicator.classList.add('opacity-0'), 2000);
            } catch (err) {
                indicator.innerText = "Saved (Local)";
            }
        }

        // --- Import/Export UI Logic ---
        let currentMethodType = 'export'; 

        window.openMethodModal = (type) => {
            currentMethodType = type;
            const modal = document.getElementById('methodModal');
            const content = document.getElementById('methodModalContent');
            
            document.getElementById('methodTitle').innerText = type === 'export' ? 'Export Data' : 'Import Data';
            
            // Wire buttons
            document.getElementById('btnMethodFile').onclick = () => {
                closeMethodModal();
                if(type === 'export') exportFile();
                else document.getElementById('importFile').click();
            };
            
            document.getElementById('btnMethodQR').onclick = () => {
                closeMethodModal();
                if(type === 'export') startHostSession(); // Host
                else startClientSession(); // Client
            };

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        };

        window.closeMethodModal = () => {
            const modal = document.getElementById('methodModal');
            const content = document.getElementById('methodModalContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        // --- WebRTC / Sync Logic ---

        function generatePhrase() {
            // Generate 3 random words
            const r = () => WORD_LIST[Math.floor(Math.random() * WORD_LIST.length)];
            return `${r()}-${r()}-${r()}`;
        }

        function startHostSession() {
            // 1. Generate ID
            const phrase = generatePhrase();
            const peerId = `cf_${phrase}`; // Prefix for uniqueness scope

            // 2. Open Modal UI
            const modal = document.getElementById('qrModal');
            document.getElementById('qrTitle').innerText = "Host Sync Session";
            document.getElementById('qrGenContainer').classList.remove('hidden');
            document.getElementById('qrGenContainer').classList.add('flex');
            document.getElementById('qrScanContainer').classList.add('hidden');
            document.getElementById('hostPhraseDisplay').innerText = phrase;
            
            // 3. Generate QR (Just the phrase/ID)
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: peerId, // Encode the full peer ID
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            // 4. Initialize PeerJS
            if(peer) peer.destroy();
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                console.log('Peer ID is: ' + id);
            });

            peer.on('connection', (conn) => {
                // Connection established
                document.getElementById('hostStatusText').innerText = "Connected! Sending data...";
                document.getElementById('hostStatusDot').classList.remove('bg-yellow-400');
                document.getElementById('hostStatusDot').classList.add('bg-success');
                
                conn.on('open', () => {
                    // Send Data
                    conn.send(state);
                    setTimeout(() => {
                        showToast("Data Sent Successfully");
                        closeQRModal();
                    }, 1000);
                });
            });
            
            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'unavailable-id') {
                    // Retry with new ID if collision (rare)
                    peer.destroy();
                    setTimeout(startHostSession, 500); 
                } else {
                    document.getElementById('hostStatusText').innerText = "Connection Error";
                    document.getElementById('hostStatusText').className = "text-danger";
                }
            });
        }

        function startClientSession() {
            const modal = document.getElementById('qrModal');
            document.getElementById('qrTitle').innerText = "Connect to Device";
            document.getElementById('qrGenContainer').classList.add('hidden');
            document.getElementById('qrGenContainer').classList.remove('flex');
            document.getElementById('qrScanContainer').classList.remove('hidden');
            document.getElementById('qrScanContainer').classList.add('flex');
            document.getElementById('clientStatus').classList.add('hidden');

            // Default to Camera
            switchScanMode('camera');

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            // Initialize Peer (Anonymous)
            if(peer) peer.destroy();
            peer = new Peer(); 
        }

        window.switchScanMode = (mode) => {
            const tabCamera = document.getElementById('tabCamera');
            const tabManual = document.getElementById('tabManual');
            const cameraView = document.getElementById('cameraView');
            const manualView = document.getElementById('manualView');

            if(mode === 'camera') {
                tabCamera.classList.add('text-primary', 'border-b-2', 'border-primary');
                tabCamera.classList.remove('text-textMuted');
                tabManual.classList.remove('text-primary', 'border-b-2', 'border-primary');
                tabManual.classList.add('text-textMuted');
                
                cameraView.classList.remove('hidden');
                manualView.classList.add('hidden');
                initScanner();
            } else {
                tabManual.classList.add('text-primary', 'border-b-2', 'border-primary');
                tabManual.classList.remove('text-textMuted');
                tabCamera.classList.remove('text-primary', 'border-b-2', 'border-primary');
                tabCamera.classList.add('text-textMuted');

                cameraView.classList.add('hidden');
                manualView.classList.remove('hidden');
                stopScanner();
            }
        }

        function initScanner() {
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {}).catch(err => {
                console.error(err);
                showToast("Camera Error", true);
            });
        }

        function stopScanner() {
            if(html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(err => console.log(err));
            }
        }

        function onScanSuccess(decodedText) {
            connectToPeer(decodedText);
        }

        window.connectToPhrase = () => {
            const val = document.getElementById('manualPhraseInput').value.trim().toLowerCase();
            if(!val) return;
            // Add prefix if missing
            const peerId = val.startsWith('cf_') ? val : `cf_${val}`;
            connectToPeer(peerId);
        }

        function connectToPeer(remoteId) {
            stopScanner();
            document.getElementById('clientStatus').classList.remove('hidden');
            document.getElementById('clientStatus').innerHTML = `<i class="ph ph-spinner animate-spin"></i> Connecting to ${remoteId.replace('cf_', '')}...`;

            const conn = peer.connect(remoteId);

            conn.on('open', () => {
                console.log("Connected to Host");
                document.getElementById('clientStatus').innerHTML = `<span class="text-success">Connected! Receiving...</span>`;
            });

            conn.on('data', (data) => {
                console.log("Received Data", data);
                if (data.transactions && typeof data.currentBalance !== 'undefined') {
                    applyState(data);
                    saveData();
                    showToast("Sync Complete!");
                    closeQRModal();
                } else {
                    showToast("Received invalid data", true);
                }
            });

            conn.on('error', (err) => {
                console.error(err);
                showToast("Connection Failed", true);
                document.getElementById('clientStatus').innerHTML = `<span class="text-danger">Failed. Check phrase.</span>`;
            });
            
            // Timeout safety
            setTimeout(() => {
                if(document.getElementById('clientStatus').innerHTML.includes('Connecting')) {
                     document.getElementById('clientStatus').innerHTML = `<span class="text-danger">Timeout. Host not found.</span>`;
                }
            }, 10000);
        }

        function closeQRModal() {
            const modal = document.getElementById('qrModal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                stopScanner();
                if(peer) {
                    peer.destroy();
                    peer = null;
                }
            }, 200);
        }

        // --- Existing Helpers ---
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            document.getElementById('toastMsg').innerText = msg;
            icon.className = isError ? "ph ph-warning-circle text-orange-400" : "ph ph-check-circle text-success";
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- Core Logic ---
        function calculateCashflow() {
            const flow = new Map();
            let simulatedBalance = state.currentBalance;
            const todayStr = new Date().toISOString().split('T')[0];
            const sortedTrans = [...state.transactions].sort((a,b) => new Date(a.date) - new Date(b.date));

            sortedTrans.forEach(t => {
                if (t.date >= todayStr) {
                    if (t.type === 'income') simulatedBalance += t.amount;
                    else simulatedBalance -= t.amount;
                }
                if (!flow.has(t.date)) flow.set(t.date, { income: 0, expense: 0, items: [] });
                const dayData = flow.get(t.date);
                if (t.type === 'income') dayData.income += t.amount;
                else dayData.expense += t.amount;
                dayData.items.push(t);
                flow.get(t.date).endBalance = simulatedBalance;
            });
            return flow;
        }

        // --- Renderers ---
        function render() {
            renderLedger();
            renderCalendar();
            updateStats();
        }

        function updateStats() {
            const income = state.transactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc, 0);
            const expense = state.transactions.reduce((acc, t) => t.type === 'expense' ? acc + t.amount : acc, 0);
            document.getElementById('statsIncoming').innerText = `$${income.toFixed(2)}`;
            document.getElementById('statsOutgoing').innerText = `$${expense.toFixed(2)}`;
            document.getElementById('entryCount').innerText = state.transactions.length;
        }

        function renderLedger() {
            const list = document.getElementById('ledgerList');
            list.innerHTML = '';
            const sorted = [...state.transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
            if (sorted.length === 0) {
                list.innerHTML = `<div class="text-center text-textMuted text-xs py-4 italic">No upcoming transactions</div>`;
                return;
            }
            const limit = 100;
            const displayList = sorted.slice(0, limit);

            displayList.forEach(t => {
                const el = document.createElement('div');
                el.className = 'group flex items-center justify-between p-2.5 rounded-lg border border-transparent hover:border-border hover:bg-white hover:shadow-sm transition-all text-xs bg-surfaceHighlight/50 mb-1';
                const isExpense = t.type === 'expense';
                const colorClass = isExpense ? 'text-danger' : 'text-success';
                const sign = isExpense ? '-' : '+';
                const recurIcon = t.groupId ? `<i class="ph ph-arrows-clockwise text-textMuted/50 text-[10px] ml-1"></i>` : '';

                el.innerHTML = `
                    <div class="flex flex-col gap-0.5">
                        <span class="font-semibold text-textMain flex items-center">${t.name} ${recurIcon}</span>
                        <span class="text-textMuted text-[10px]">${t.date}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-medium ${colorClass}">${sign}$${t.amount.toFixed(2)}</span>
                        <div class="flex gap-1 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity">
                            <button onclick="editTransaction('${t.id}')" class="p-1.5 rounded hover:bg-surfaceHighlight text-textMuted hover:text-primary transition-all" title="Edit"><i class="ph ph-pencil-simple text-sm"></i></button>
                            <button onclick="promptDelete('${t.id}')" class="p-1.5 rounded hover:bg-red-50 text-textMuted hover:text-danger transition-all" title="Delete"><i class="ph ph-trash text-sm"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
            if (sorted.length > limit) {
                const more = document.createElement('div');
                more.innerText = `+${sorted.length - limit} more transactions`;
                list.appendChild(more);
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar');
            grid.innerHTML = '';
            const flowData = calculateCashflow();
            const year = state.viewDate.getFullYear();
            const month = state.viewDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('monthDisplay').innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); 
            const todayStr = new Date().toISOString().split('T')[0];
            
            for (let i = 0; i < startDayOfWeek; i++) {
                const pad = document.createElement('div');
                pad.className = 'bg-surfaceHighlight/20 border-r border-b border-border/50';
                grid.appendChild(pad);
            }

            let runningBalanceDisplay = state.currentBalance;
            const viewStartStr = `${year}-${String(month+1).padStart(2,'0')}-01`;
            if (viewStartStr > todayStr) {
                 state.transactions.forEach(t => {
                     if (t.date >= todayStr && t.date < viewStartStr) {
                         if (t.type === 'income') runningBalanceDisplay += t.amount;
                         else runningBalanceDisplay -= t.amount;
                     }
                 });
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = dateStr === todayStr;
                const isPast = dateStr < todayStr;
                const dayData = flowData.get(dateStr);
                
                if (dayData && !isPast) {
                    if (dayData.items.length > 0) {
                        const netChange = dayData.income - dayData.expense;
                        runningBalanceDisplay += netChange;
                    }
                }

                const cell = document.createElement('div');
                let baseClasses = "calendar-cell p-1.5 lg:p-2 flex flex-col justify-between relative border-r border-b border-border/50";
                if (isToday) baseClasses += " today ring-1 ring-inset ring-primary/20";
                if (!isPast && runningBalanceDisplay < state.minBalance) baseClasses += " negative-balance";
                cell.className = baseClasses;

                cell.onclick = () => {
                    document.getElementById('transDate').value = dateStr;
                    openForm();
                    if(window.innerWidth < 1024) document.querySelector('aside').scrollIntoView({ behavior: 'smooth' });
                };

                const dateNum = document.createElement('span');
                dateNum.className = `text-[10px] lg:text-xs font-mono mb-1 ${isToday ? 'text-primary font-bold' : 'text-textMuted'}`;
                dateNum.innerText = d;
                cell.appendChild(dateNum);

                const transContainer = document.createElement('div');
                transContainer.className = 'flex flex-col gap-0.5 lg:gap-1 overflow-hidden';
                if (dayData && dayData.items) {
                    dayData.items.forEach(item => {
                        const dot = document.createElement('div');
                        dot.className = `group flex items-center justify-between gap-1 w-full text-[8px] lg:text-[10px] px-1 py-0.5 rounded font-medium cursor-pointer transition-all hover:brightness-95 active:scale-95 ${item.type === 'income' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                        const textSpan = document.createElement('span');
                        textSpan.className = "truncate";
                        textSpan.innerText = item.name;
                        const delBtn = document.createElement('button');
                        delBtn.innerHTML = "&times;";
                        delBtn.className = "chip-delete text-xs font-bold px-1 hover:text-black/50 rounded";
                        delBtn.onclick = (e) => { e.stopPropagation(); promptDelete(item.id); }
                        dot.onclick = (e) => { e.stopPropagation(); editTransaction(item.id); };
                        dot.appendChild(textSpan);
                        dot.appendChild(delBtn);
                        transContainer.appendChild(dot);
                    });
                }
                cell.appendChild(transContainer);

                if (!isPast) {
                    const balanceDiv = document.createElement('div');
                    const balanceClass = runningBalanceDisplay < state.minBalance ? 'text-danger font-bold' : 'text-textMuted';
                    balanceDiv.className = `mt-auto text-right text-[9px] lg:text-[10px] font-mono font-medium ${balanceClass}`;
                    balanceDiv.innerText = `$${Math.round(runningBalanceDisplay).toLocaleString()}`;
                    cell.appendChild(balanceDiv);
                }
                grid.appendChild(cell);
            }
            
            const eomEl = document.getElementById('eomBalance');
            eomEl.innerText = `$${runningBalanceDisplay.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            eomEl.className = `text-xl lg:text-2xl font-mono font-semibold ${runningBalanceDisplay < state.minBalance ? 'text-danger' : 'text-textMain'}`;
        }

        // --- Collapsible Logic ---
        function setupCollapsible() {
            document.getElementById('toggleFormBtn').addEventListener('click', toggleForm);
        }
        function toggleForm() {
            const container = document.getElementById('transactionFormContainer');
            const chevron = document.getElementById('formChevron');
            if (container.classList.contains('expanded-content')) {
                container.classList.remove('expanded-content');
                container.classList.add('collapsed-content');
                chevron.classList.add('chevron-rotated');
            } else {
                openForm();
            }
        }
        function openForm() {
            const container = document.getElementById('transactionFormContainer');
            const chevron = document.getElementById('formChevron');
            container.classList.remove('collapsed-content');
            container.classList.add('expanded-content');
            chevron.classList.remove('chevron-rotated');
        }
        function setupLedgerCollapsible() {
            document.getElementById('toggleLedgerBtn').addEventListener('click', toggleLedger);
        }
        function toggleLedger() {
            const container = document.getElementById('ledgerList');
            const chevron = document.getElementById('ledgerChevron');
            if (container.classList.contains('expanded-list-content')) {
                container.classList.remove('expanded-list-content');
                container.classList.add('collapsed-content');
                chevron.classList.add('chevron-rotated');
            } else {
                container.classList.remove('collapsed-content');
                container.classList.add('expanded-list-content');
                chevron.classList.remove('chevron-rotated');
            }
        }

        // --- Logic: Editing ---
        window.editTransaction = (id) => {
            const item = state.transactions.find(t => t.id === id);
            if (!item) return;
            editingId = id;
            openForm();
            document.getElementById('transName').value = item.name;
            document.getElementById('transAmount').value = item.amount;
            document.getElementById('transType').value = item.type;
            document.getElementById('transDate').value = item.date;
            document.getElementById('formTitle').innerText = 'Edit Entry';
            document.getElementById('btnSubmitText').innerText = 'Update';
            document.getElementById('btnSubmitIcon').className = 'ph ph-check text-success text-sm';
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            document.getElementById('btnCancelEdit').classList.add('flex');
            document.getElementById('transRecur').value = 'none';
            if(window.innerWidth < 1024) document.querySelector('aside').scrollIntoView({ behavior: 'smooth' });
        };

        window.cancelEdit = () => {
            editingId = null;
            document.getElementById('transactionForm').reset();
            document.getElementById('transDate').valueAsDate = new Date();
            document.getElementById('formTitle').innerText = 'Add Entry';
            document.getElementById('btnSubmitText').innerText = 'Add';
            document.getElementById('btnSubmitIcon').className = 'ph ph-plus text-primary text-sm';
            document.getElementById('btnCancelEdit').classList.add('hidden');
            document.getElementById('btnCancelEdit').classList.remove('flex');
            document.getElementById('transRecur').value = 'none';
        };

        // --- Modal Logic ---
        const modal = document.getElementById('choiceModal');
        const modalIconWrapper = document.getElementById('choiceIconWrapper');
        const modalIcon = document.getElementById('choiceIcon');
        const modalTitle = document.getElementById('choiceTitle');
        const modalDesc = document.getElementById('choiceDesc');

        window.promptDelete = (id) => {
            const item = state.transactions.find(t => t.id === id);
            if(!item) return;
            if (!item.groupId) { if(confirm('Delete this transaction?')) executeAction('delete', 'this', id); return; }
            openChoiceModal('delete', id);
        };

        function openChoiceModal(mode, id, payload = null) {
            modalContext = { mode, targetId: id, payload };
            if (mode === 'delete') {
                modalIconWrapper.className = "w-10 h-10 rounded-full bg-red-50 text-danger flex items-center justify-center mb-4";
                modalIcon.className = "ph ph-trash text-xl";
                modalTitle.innerText = "Delete Recurring Item";
                modalDesc.innerText = "Do you want to delete only this instance, or future ones as well?";
            } else {
                modalIconWrapper.className = "w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center mb-4";
                modalIcon.className = "ph ph-pencil-simple text-xl";
                modalTitle.innerText = "Edit Recurring Item";
                modalDesc.innerText = "Do you want to apply these changes to the series?";
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById('choiceModalContent').classList.remove('scale-95'); document.getElementById('choiceModalContent').classList.add('scale-100'); }, 10);
        }

        function closeChoiceModal() {
            modal.classList.add('opacity-0');
            document.getElementById('choiceModalContent').classList.remove('scale-100');
            document.getElementById('choiceModalContent').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function executeAction(action, scope, id, payload = null) {
            const target = state.transactions.find(t => t.id === id);
            if (!target) return;
            if (action === 'delete') {
                if (scope === 'this') state.transactions = state.transactions.filter(t => t.id !== id);
                else if (scope === 'future') state.transactions = state.transactions.filter(t => !(t.groupId === target.groupId && t.date >= target.date));
                else if (scope === 'all') state.transactions = state.transactions.filter(t => t.groupId !== target.groupId);
                showToast('Deleted Successfully');
                if (editingId === id) cancelEdit();
            } else if (action === 'edit') {
                const { name, amount, type, dateStr, recurrence } = payload;
                if (scope === 'this') {
                    const index = state.transactions.findIndex(t => t.id === id);
                    if (index !== -1) state.transactions[index] = { ...state.transactions[index], name, amount, type, date: dateStr, groupId: null };
                } else if (scope === 'future') {
                    state.transactions = state.transactions.filter(t => !(t.groupId === target.groupId && t.date >= target.date));
                    const newGroupId = crypto.randomUUID();
                    state.transactions.push({ id: crypto.randomUUID(), name, amount, type, date: dateStr, groupId: newGroupId });
                    if (recurrence !== 'none') state.transactions.push(...generateRecurrenceSeries(dateStr, recurrence, name, amount, type, newGroupId));
                } else if (scope === 'all') {
                    state.transactions.forEach(t => { if (t.groupId === target.groupId) { t.name = name; t.amount = amount; t.type = type; } });
                }
                showToast('Updated Successfully');
                cancelEdit();
            }
            saveData();
            closeChoiceModal();
        }

        // --- Listeners ---
        function setupModalListeners() {
            document.getElementById('btnChoiceCancel').addEventListener('click', closeChoiceModal);
            document.getElementById('btnChoiceThis').addEventListener('click', () => executeAction(modalContext.mode, 'this', modalContext.targetId, modalContext.payload));
            document.getElementById('btnChoiceFuture').addEventListener('click', () => executeAction(modalContext.mode, 'future', modalContext.targetId, modalContext.payload));
            document.getElementById('btnChoiceAll').addEventListener('click', () => executeAction(modalContext.mode, 'all', modalContext.targetId, modalContext.payload));
            modal.addEventListener('click', (e) => { if (e.target === modal) closeChoiceModal(); });
        }

        document.getElementById('currentBalance').addEventListener('change', (e) => { state.currentBalance = parseFloat(e.target.value) || 0; saveData(); });
        document.getElementById('minBalance').addEventListener('change', (e) => { state.minBalance = parseFloat(e.target.value) || 0; saveData(); });

        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('transName').value;
            const amount = parseFloat(document.getElementById('transAmount').value);
            const type = document.getElementById('transType').value;
            const dateStr = document.getElementById('transDate').value;
            const recurrence = document.getElementById('transRecur').value;
            if (!name || isNaN(amount) || !dateStr) return;

            if (editingId) {
                const item = state.transactions.find(t => t.id === editingId);
                if (item && item.groupId) {
                    if (recurrence !== 'none') executeAction('edit', 'future', editingId, { name, amount, type, dateStr, recurrence });
                    else openChoiceModal('edit', editingId, { name, amount, type, dateStr, recurrence });
                } else {
                    executeAction('edit', 'this', editingId, { name, amount, type, dateStr, recurrence });
                }
            } else {
                const groupId = recurrence !== 'none' ? crypto.randomUUID() : null;
                const newTransactions = [];
                if (recurrence === 'none') newTransactions.push({ id: crypto.randomUUID(), name, amount, type, date: dateStr, groupId: null });
                else {
                    newTransactions.push({ id: crypto.randomUUID(), name, amount, type, date: dateStr, groupId });
                    newTransactions.push(...generateRecurrenceSeries(dateStr, recurrence, name, amount, type, groupId));
                }
                state.transactions.push(...newTransactions);
                e.target.reset();
                document.getElementById('transDate').valueAsDate = new Date();
                document.getElementById('transRecur').value = 'none';
                showToast(recurrence === 'none' ? 'Transaction Added' : `Series Created (${newTransactions.length})`);
                saveData();
            }
        });

        function generateRecurrenceSeries(startDateStr, recurrence, name, amount, type, groupId) {
            const newItems = [];
            let currentDate = new Date(startDateStr + 'T12:00:00');
            if (recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
            else if (recurrence === 'biweekly') currentDate.setDate(currentDate.getDate() + 14);
            else if (recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
            else if (recurrence === 'yearly') currentDate.setFullYear(currentDate.getFullYear() + 1);
            const endDate = new Date(currentDate);
            endDate.setFullYear(endDate.getFullYear() + 1); 
            while (currentDate <= endDate) {
                const isoDate = currentDate.toISOString().split('T')[0];
                newItems.push({ id: crypto.randomUUID(), name, amount, type, date: isoDate, groupId });
                if (recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                else if (recurrence === 'biweekly') currentDate.setDate(currentDate.getDate() + 14);
                else if (recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                else if (recurrence === 'yearly') currentDate.setFullYear(currentDate.getFullYear() + 1);
            }
            return newItems;
        }

        document.getElementById('prevMonth').addEventListener('click', () => { state.viewDate.setMonth(state.viewDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('nextMonth').addEventListener('click', () => { state.viewDate.setMonth(state.viewDate.getMonth() + 1); renderCalendar(); });

        window.exportFile = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "cashflow_backup.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        };

        document.getElementById('importFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (parsed.transactions) {
                        applyState(parsed);
                        saveData();
                        showToast('Data Imported Successfully');
                    }
                } catch (err) { showToast('Error parsing file', true); }
            };
            reader.readAsText(file);
        });

        init();
    </script>
</body>
</html>